<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>How to run DbUp in an AppHarbor ASP.NET MVC application</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description" content="Bec d'état, Rebecca Scott's personal blog"/>
		<meta name="author" content="Rebecca Scott"/>
		<link rel="icon" href="/favicon.ico"/>
		<link href="//fonts.googleapis.com/css?family=Cinzel" rel="stylesheet" type="text/css"/>
		<link href="//fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet" type="text/css"/>
		<link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
		<link href="/lib/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet"/>
		<link href="/css/site.css" rel="stylesheet"/>
	</head>
	<body>
		<div class="container">
			<div class="row header">
				<h1><a href="https://becdetat.com">Bec d'état</a></h1>
				<h2>
					<a href="https://becdetat.com">Rebecca Scott's Blog</a>
					<br/>
					<a href="/about-me">About me</a> |
					<a href="/resume">Resume</a>
					<br/>
					<a href="https://www.linkedin.com/in/rebecca-scott-b522a418/" target="_blank">LinkedIn</a> |
					<a href="https://github.com/becdetat" target="_blank">GitHub</a> |
					<a href="mailto:me@becdetat.com">me@becdetat.com</a>
				</h2>
			</div>
		</div>

		<hr/>

		<div class="container">
			<div class="row content">

				<!-- CONTENT! -->
				<h1><a href="/">~/</a>How to run DbUp in an AppHarbor ASP.NET MVC application <br/></h1>
<h2><small><em>31 Aug 2013</em></small></h2>

<p><a href="https://twitter.com/PawelPabich">Pawel Pabich</a> has a good way to <a href="https://www.pabich.eu/2011/03/automated-database-deployments-to.html">run DbUp as part of AppHarbor’s build process</a> which looks interesting but I wanted to run the migrations manually. So here is a quick recipe for setting up <a href="https://dbup.github.io/">DbUp</a> with a web hook.</p>

<p>Something important to note is that there is no security around this. It relies on an obfuscated controller path, so it is only really useful for bootstrapping an early project. The controller should be moved behind security as soon as possible.</p>

<p>I’m assuming that DbUp has been set up as per my post on <a href="/reset-the-world.html">resetting the world</a>. Specifically, the DbUp DLL should have an upgrader that looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>namespace ResetTheWorld
{
    public class DatabaseUpgrader
    {
        private const string ConnectionStringName = "xyz";

        public static void Upgrade(IUpgradeLog upgradeLog = null)
        {
            var connectionString = ConfigurationManager.ConnectionStrings[ConnectionStringName].ConnectionString;
            var upgrader = DeployChanges.To
				.SqlDatabase(connectionString)
				.WithScriptsEmbeddedInAssembly(Assembly.GetAssembly(typeof (DatabaseUpgrader)))
				.LogTo(upgradeLog ?? new ConsoleUpgradeLog())
				.Build();

            var result = upgrader.PerformUpgrade();

            if (!result.Successful)
            {
                throw new Exception("DB Upgrade failed", result.Error);
            }
        }

        public static void SetConnectionString(string connectionString)
        {
			typeof (ConfigurationElementCollection).GetField("bReadOnly", BindingFlags.Instance | BindingFlags.NonPublic)
				.SetValue(ConfigurationManager.ConnectionStrings, false);
			ConfigurationManager.ConnectionStrings.Add(new ConnectionStringSettings(ConnectionStringName,
				connectionString,
				"System.Data.SqlClient"));
        }
    }
}
</code></pre></div></div>

<p>I’ve just created a controller with a long random name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class njvfdklnvfjdkslndsieController : Controller
{
	public ActionResult UpdateTheWorld()
	{
		var log = new HtmlLog();

		DatabaseUpgrader.Upgrade(log);

		ViewBag.Log = log.ToString();

		return View();
	}
}
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">HtmlLog</code> is a basic replacement for DbUp’s console log that just builds up a HTML string:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class HtmlLog : IUpgradeLog
{
	readonly StringBuilder _stringBuilder = new StringBuilder();
	public override string ToString()
	{
		return _stringBuilder.ToString();
	}

	public void WriteError(string format, params object[] args)
	{
		_stringBuilder.AppendFormat("&lt;p class='error'&gt;" + format + "&lt;/p&gt;", args);
	}

	public void WriteInformation(string format, params object[] args)
	{
		_stringBuilder.AppendFormat("&lt;p class='information'&gt;" + format + "&lt;/p&gt;", args);
	}

	public void WriteWarning(string format, params object[] args)
	{
		_stringBuilder.AppendFormat("&lt;p class='warning'&gt;" + format + "&lt;/p&gt;", args);
	}
}
</code></pre></div></div>

<p>And the view for the <code class="language-plaintext highlighter-rouge">UpdateTheWorld()</code> action just writes out the log, with added colours:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@model dynamic

@{
	ViewBag.Title = "UpdateTheWorld";
}

&lt;style&gt;
	p.error{color:red}
	p.information{color:#000}
	p.warning{color:orange}
&lt;/style&gt;

&lt;h1&gt;UpdateTheWorld&lt;/h1&gt;
@Html.Raw(ViewBag.Log)
</code></pre></div></div>

<p>Now browsing to <code class="language-plaintext highlighter-rouge">https://&lt;app&gt;.apphb.com/njvfdklnvfjdkslndsie/UpdateTheWorld</code> will update the existing database. A <code class="language-plaintext highlighter-rouge">ResetTheWorld</code> action could be added which drops the database before running the scripts.</p>



<br/>

<div id="disqus_thread"></div>
<script>
    (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://becdetat.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

				<!-- /CONTENT! -->

			</div>
		</div>

		<hr/>

		<div class="container">
			<div class="row footer">
				<p><small>
					Content &copy; 2008-2022 Rebecca Scott<br/>
					<a href="https://www.linkedin.com/in/rebecca-scott-b522a418/" target="_blank">LinkedIn</a> |
					<a href="https://github.com/becdetat" target="_blank">GitHub</a> |
					<a href="mailto:me@becdetat.com">me@becdetat.com</a>
				</small></p>
			</div>
		</div>

		<script src="/lib/jquery-2.0.2.min.js"></script>
		<script src="/lib/bootstrap/js/bootstrap.min.js"></script>
		<script src="//google-code-prettify.googlecode.com/svn/loader/run_prettify.js" type="text/javascript"></script>
		<script src="/js/site.js"></script>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-67018713-1', 'auto');
		  ga('send', 'pageview');
		</script>
	</body>
</html>
